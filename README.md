# atdf-device-file-maker
Generate device-specifc files for PIC32 and SAM device (ARM-only for now), like linker scripts
and header files.

## Intro
This is sort of a port of my **generatePic32SpecificStuff** project. That project uses Java and
is a plugin for MPLAB X to access its internal database. This project will not do that, but instead
you'll tell it where the database is. If you have MPLAB X installed, look for a "packs"
directory in its install location or in your user directory for a ".mchp_packs" directory.

The other project was also quite concerned with maintaining a fair amount of compatibility with
Microchip's files. This project is not going to be as concerned with that, at least to start. I
have no plans to use these files with Microcip's XC32 compiler or Harmony framework, so there is
not really a reason to worry about it. This comes with the additional benefit of not having to worry
as much about licenses and the legality of mimicking Microchip's code.

Any similarity to Microchip's device files is either coincidental or the result of functional
requirements. This code, presumably like Microchip's/Atmel's code, uses Arm CMSIS 6 as a template
and so there will probably be a lot of similarities because of that. Find CMSIS 6 on GitHub at
https://github.com/ARM-software/CMSIS_6/tree/main.

If you modify this project, be sure to add your name to the copyright string list in 
"file_makers/strings.py". You will see a comment in there showing where and how to add it.

## Finding the Packs
This app works by parsing specially-formatted XML files found in what Microchip called "device packs".
A device pack is a collection of files generated by Microchip that provide info about a series of
devices. In particular, this app parses the XML files ending with the ".atdf" extension, hence the
name of this project. Packs do contain things like header files and linker scripts--the sorts of file
this app is creating for  you--but those rely on extensions Microchip has made to GCC to make their
XC32 compiler and so are not usable with a "normal" toolchain.

You need to find where these packs are located so you can pass that as a command-line argument to
this script. The packs are in a couple of places.

- If you have MPLAB X installed, look for a "packs" directory at the install location. For example,
on Windows this would be `C:/Program Files/MPLAB X/<version>/packs`. On Linux, this would be
`/opt/microchip/mplabx/<version>/packs`.
- MPLAB X can download pack updates for you. Those go into your user or home directory in a 
`.mchp_packs` subdirectory. On Windows, this would be `C:/Users/<you>/.mchp_packs`. On Linux, this
is in your home directory.
- You can also manually download packs from https://packs.download.microchip.com/. This can be handy
for getting the newest packs and ensuring you can the packs for the devices you care about.

The most comprehensive strategy is to use MPLAB X to get all pack updates, then merge those two
directories above into a third location that will contain everything. You can also manually download
whatever packs you need into this location using the URL above. You will probably want to keep this
merged directory somewhere safe as an archive for later use. Your packs directory may contain multiple
versions of a pack. The version of a pack is indicated in its directory structure. This app will try
to find the version and use the latest version for each device.

I'm not yet sure how the MPLAB Extensions for VS Code will handle packs, but I presume it'll still
use the `.mchp_packs` location or something similar.

## A Quick Word of Caution
This project uses the default XML parsers in Python, which are vulnerable to certain attacks
relying on XML entities referecing other entities multiple times. Specifically, the attacks are
called "Billion Laughs" and "Quadratic Blowup". Therefore, you should ensure that the packs files
you give to this module are really from Microchip and not some malicious user. See the info here:
https://docs.python.org/3/library/xml.html#module-xml. That page has a link to a package called
"defusedxml" you can use if you want to be safer. You should just need to get it from PIP and
update the import statement for ElementTree in the modules that use it.

## Running the App
This app was written using Python 3.10, so you should try to get at least that version. Slightly
older versions might work, like Python 3.8 or so, but there's no guarantee. You can run the app
from the command-line like so:

`python3 ./atdf-device-file-maker.py <packs_dir>`

This will look for the ".atdf" files in the given "packs_dir" and output the generated files to
your working directory (that is, the directory from which you ran the app). You can optionally change
the ouput directory with the `--output_dir` option. The generated files are always put into a
subdirectory called `atdf-device-files` in your chosen output directory.

This app will create a device-specific configuration file for each device it finds. You would pass
this to Clang with the `--config` option to use your desired device. Use the `--define-macro <macro>`
option to add a macro definition to each device config file. The `<macro>` argument needs to follow
the same convention as Clang's (and GCC's) `-D` option. You can specify this option multiple times
to add multiple macros. If you are running this app through the [buildMchpClang](https://github.com/jdeguire/buildMchpClang)
script, then that will pass macros to this app specifying version numbers of the mchpClang toolset.

This app uses the Python `multiprocess` module to parse the device info files. You can control how
many processes are created to do this using the `--parse-jobs` argument. The default and maximum
allowed is one per CPU.

You can also use `--help` or `-h` to get some help text on the command line or use `--version` to
print a bit of version info.

## License
This app is covered by the standard 3-clause BSD license. See the LICENSE file in this directory
for the full license text.

The files created by this app are covered under the Apache 2.0 license. A copy of the license is
output along with the generated files in a LICENSE file at the top level of the output directory.
The Apache license is used because that is what Arm's CMSIS framework uses and many of the files
created by this app are based on examples provided in CMSIS.

## Trademarks
This project and the similarly-named ones make references to "PIC32", "SAM", "XC32", and "MPLAB"
products from Microchip Technology. Those names are trademarks or registered trademarks of Microchip
Technology.

These projects also refer to "Arm", "ARM", "Cortex", and "CMSIS", which are all trademarks of Arm
Limited.

These projects are all independent efforts not affiliated with, endorsed, sponsored, or otherwise
approved by Microchip Technology nor Arm Limited.
