# pic32-device-file-maker
Generate device-specifc files for PIC32 and SAM device (ARM-only for now), like linker scripts
and header files.

## Intro
This is sort of a port of my **generatePic32SpecificStuff** project. That project uses Java and
is a plugin for MPLAB X to access its internal database. This project will not do that, but instead
you'll tell it where the database is. If you have MPLAB X installed, look for a "packs"
directory in its install location or in your user directory for a ".mchp_packs" directory.

The other project was also quite concerned with maintaining a fair amount of compatibility with
Microchip's files. This project is not going to be as concerned with that, at least to start. I
have no plans to use these files with Microcip's XC32 compiler or Harmony framework, so there is
not really a reason to worry about it. This comes with the additional benefit of not having to worry
as much about licenses and the legality of mimicking Microchip's code.

Any similarity to Microchip's device files is either coincidental or the result of functional
requirements. This code, presumably like Microchip's/Atmel's code, uses Arm CMSIS 6 as a template
and so there will probably be a lot of similarities because of that. Find CMSIS 6 on GitHub at
https://github.com/ARM-software/CMSIS_6/tree/main.

If you modify this project, be sure to add your name to the copyright string list in 
"file_makers/strings.py". You will see a comment in there showing where and how to add it.

## Finding the Packs
This app works by parsing specially-formatted XML files found in what Microchip called "device packs".
A device pack is a collection of files generated by Microchip that provide info about a series of
devices. In particular, this app parses the XML files ending with the ".atdf" extension. Packs do
contain things like header files and linker scripts--the sorts of file this app is creating for 
you--but those rely on extensions Microchip has made to GCC to make their XC32 compiler and so are
not usable with a "normal" toolchain.

You need to find where these packs are located so you can pass that as a command-line argument to
this script. Here are a few options for finding them.

- If you have MPLAB X installed, look for a "packs" directory at the install location. For example,
on Windows this would be `C:/Program Files/MPLAB X/<version>/packs`.
- MPLAB X can download pack updates for you. Those go into your user or home directory in a 
`.mchp_packs` subdirectory. On Windows, this would be `C:/Users/<you>/.mchp_packs`.
- If you downloaded Harmony 3, you should have a `dev_packs` directory somewhere in the location
you downloaded Harmony 3. If not, you can get the packs from the `dev_packs` repository found on
the Microchip-MPLAB-Harmony GitHub page.

Of these three options, the second one seems to be the most up-to-date. I'm not yet sure how the
MPLAB Extensions for VS Code will handle packs, but I presume it'll still use the `.mchp_packs`
location or something similar.

Once you find the packs you need, you can copy that directory to somewhere easier to remember, such
as wherever you downloaded this app.

A packs directory may contain multiple versions of a pack. The app makes sure to only parse one
file per device, so you don't need to remove extra versions. The app relies on whatever order
Python's `os.walk()` function uses, so there isn't a guarantee that you'll get the latest pack, but
it's likely you will.

## A Quick Word of Caution
This project uses the default XML parsers in Python, which are vulnerable to certain attacks
relying on XML entities referecing other entities multiple times. Specifically, the attacks are
called "Billion Laughs" and "Quadratic Blowup". Therefore, you should ensure that the packs files
you give to this module are really from Microchip and not some malicious user. See the info here:
https://docs.python.org/3/library/xml.html#module-xml. That page has a link to a package called
"defusedxml" you can use if you want to be safer. You should just need to get it from PIP and
update the import statement for ElementTree below and in other modules to use it.

## Running the App
This app was written using Python 3.10, so you should try to get at least that version. Slightly
older versions might work, like Python 3.8 or so, but there's no guarantee. You can run the app
from the command-line like so:

`python3 ./main.py <packs_dir>`

This will look for the ".atdf" files in the given "packs_dir" and output the generated files to
your working directory (that is, the directory from which you ran the app). You can optionally change
the ouput directory with the `--output_dir` option. The generated files are always put into a
subdirectory called `pic32-device-files` in your chosen output directory.
 
You can also use `--help` or `-h` to get some help text on the command line or use `--version` to
print a bit of version info.
